name: Build and Release

on:
  # åœ¨pushåˆ°mainåˆ†æ”¯æ—¶è¿è¡Œï¼ˆç”¨äºæµ‹è¯•æ„å»ºï¼‰
  push:
    branches: [ main ]
    # åœ¨åˆ›å»ºtagæ—¶è¿è¡Œï¼ˆç”¨äºå‘å¸ƒï¼‰
    tags:
      - 'v*'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®ç¯å¢ƒå˜é‡
env:
  # ç¼“å­˜pnpmå­˜å‚¨è·¯å¾„
  PNPM_CACHE_FOLDER: .pnpm-store

jobs:
  # ä»£ç æ£€æŸ¥å’Œæµ‹è¯•job
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-store
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint check (if available)
        run: |
          if [ -f "package.json" ] && grep -q '"lint"' package.json; then
            pnpm run lint
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true

  # æ„å»ºjob - æ”¯æŒå¤šå¹³å°
  build:
    needs: test
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-store
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Linuxç‰¹å®šè®¾ç½®
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libgtk-3-dev libxss1 libasound2-dev

      # macOSç‰¹å®šè®¾ç½® - è®¾ç½®è¯ä¹¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      - name: Setup macOS certificate
        if: matrix.os == 'macos-latest'
        run: |
          # å¦‚æœä½ æœ‰Appleå¼€å‘è€…è¯ä¹¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®
          # ç°åœ¨å…ˆè·³è¿‡ä»£ç ç­¾å
          echo "SKIP_NOTARIZATION=true" >> $GITHUB_ENV
        env:
          # æ·»åŠ è¿™äº›ç¯å¢ƒå˜é‡ä»¥è·³è¿‡macOSå…¬è¯
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # Windowsç‰¹å®šè®¾ç½®
      - name: Setup Windows environment
        if: matrix.os == 'windows-latest'
        run: |
          # Windowsç¯å¢ƒå˜é‡è®¾ç½®
          echo "ELECTRON_CACHE=$env:USERPROFILE\.cache\electron" >> $env:GITHUB_ENV
          echo "ELECTRON_BUILDER_CACHE=$env:USERPROFILE\.cache\electron-builder" >> $env:GITHUB_ENV

      # æ„å»ºåº”ç”¨
      - name: Build application
        run: pnpm run build
        env:
          # GitHub tokenç”¨äºå‘å¸ƒ
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # è·³è¿‡macOSå…¬è¯ï¼ˆå¦‚æœæ²¡æœ‰å¼€å‘è€…è´¦å·ï¼‰
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: my-browser-${{ matrix.os }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
            dist/*.zip
          if-no-files-found: ignore

  # å‘å¸ƒjob - åªåœ¨tagæ¨é€æ—¶è¿è¡Œ
  release:
    permissions:
      contents: write
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          files: |
            artifacts/my-browser-windows-latest/*
            artifacts/my-browser-macos-latest/*
            artifacts/my-browser-ubuntu-latest/*
          body: |
            ## ğŸš€ My Browser ${{ github.ref_name }}
            
            ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
            
            #### Windows
            - `.exe` - Windowså®‰è£…ç¨‹åº
            
            #### macOS
            - `.dmg` - macOSç£ç›˜æ˜ åƒ
            
            #### Linux
            - `.AppImage` - ä¾¿æºå¼åº”ç”¨ç¨‹åº
            - `.deb` - Debian/UbuntuåŒ…
            - `.rpm` - Red Hat/FedoraåŒ…
            
            ### ğŸ”„ æ›´æ–°å†…å®¹
            
            è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}

      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ github.ref_name }}
      #     release_name: My Browser ${{ github.ref_name }}
      #     body: |
      #       ## ğŸš€ My Browser ${{ github.ref_name }}
            
      #       ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
            
      #       #### Windows
      #       - `.exe` - Windowså®‰è£…ç¨‹åº
            
      #       #### macOS
      #       - `.dmg` - macOSç£ç›˜æ˜ åƒ
            
      #       #### Linux
      #       - `.AppImage` - ä¾¿æºå¼åº”ç”¨ç¨‹åº
      #       - `.deb` - Debian/UbuntuåŒ…
      #       - `.rpm` - Red Hat/FedoraåŒ…
            
      #       ### ğŸ”„ æ›´æ–°å†…å®¹
            
      #       è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
            
      #       ---
            
      #       **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}
      #     draft: false
      #     prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}

      # ä¸Šä¼ å„å¹³å°çš„å®‰è£…åŒ…åˆ°Release
      # - name: Upload Windows artifacts
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: artifacts/my-browser-windows-latest
      #     asset_name: my-browser-windows.zip
      #     asset_content_type: application/zip
      #   continue-on-error: true

      # - name: Upload macOS artifacts
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: artifacts/my-browser-macos-latest
      #     asset_name: my-browser-macos.zip
      #     asset_content_type: application/zip
      #   continue-on-error: true

      # - name: Upload Linux artifacts
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: artifacts/my-browser-ubuntu-latest
      #     asset_name: my-browser-linux.zip
      #     asset_content_type: application/zip
      #   continue-on-error: true

  # æ„å»ºé€šçŸ¥job
  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Success Notification
        if: needs.build.result == 'success'
        run: |
          echo "âœ… Build completed successfully!"
          echo "Platform builds status:"
          echo "  - Ubuntu: ${{ needs.build.result }}"
          echo "  - Windows: ${{ needs.build.result }}"
          echo "  - macOS: ${{ needs.build.result }}"

      - name: Build Failure Notification
        if: needs.build.result == 'failure'
        run: |
          echo "âŒ Build failed!"
          echo "Please check the logs for details."
          exit 1

      - name: Release Status
        if: needs.release.result != 'skipped'
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "ğŸ‰ Release created successfully!"
          else
            echo "âš ï¸  Release creation failed or was skipped."
          fi
